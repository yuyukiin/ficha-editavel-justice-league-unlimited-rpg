<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossi√™: Justice League Unlimited</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
<body>

<div class="pax-bar">
    <div class="pax-info">
        <span class="pax-label">RANK:</span> <span id="rankDisplay" class="pax-value">D</span>
    </div>
    <div class="pax-info">
        <span class="pax-label">PAX:</span> 
        <span id="paxSpentDisplay" class="pax-value">0</span> 
        <span class="pax-label" style="font-size: 1.2rem; color:#666;">/</span> 
        <span id="paxMaxDisplay" class="pax-value" style="color: #888;">40</span>
        <span id="paxStatus" class="pax-status"></span>
    </div>
</div>

<div class="dossier-container">
    <header>
        <div>
            <div class="subtitle">JUSTICE LEAGUE UNLIMITED</div>
            <h1>DOSSI√ä DO HER√ìI</h1>
        </div>
        
        <div>
            <label style="text-align: right; margin-bottom: 5px;">N√çVEL DE AMEA√áA</label>
            <div class="tier-selector" style="display:flex; gap:5px;">
                <div class="tier-btn active" onclick="setTier(this, 'D')">D</div>
                <div class="tier-btn" onclick="setTier(this, 'C')">C</div>
                <div class="tier-btn" onclick="setTier(this, 'B')">B</div>
                <div class="tier-btn" onclick="setTier(this, 'A')">A</div>
                <div class="tier-btn" onclick="setTier(this, 'S')">S</div>
            </div>
            <input type="hidden" id="tierValue" value="D">
        </div>
    </header>

    <div class="grid-3">
        <div class="input-group"><label>IDENTIDADE CIVIL</label><input type="text" id="civilID"></div>
        <div class="input-group"><label>NOME DE HER√ìI</label><input type="text" id="heroName" style="color: var(--dc-gold); font-weight: bold;"></div>
        <div class="input-group"><label>MENTOR / GRUPO</label><input type="text" id="mentor"></div>
    </div>
    <div class="grid-3">
        <div class="input-group">
            <label>ORIGEM</label>
            <select id="origin" onchange="applyOriginLogic()">
                <option value="">-- SELECIONE --</option>
                <option value="Humano">Humano</option>
                <option value="Meta-Humano">Meta-Humano</option>
                <option value="Kryptoniano">Kryptoniano</option>
                <option value="Amazona">Amazona</option>
                <option value="Atlante">Atlante</option>
                <option value="Alien√≠gena">Alien√≠gena</option>
                <option value="Tecnol√≥gico">Tecnol√≥gico</option>
            </select>
        </div>
        <div class="input-group">
            <label>ARQU√âTIPO</label>
            <select id="archetype">
                <option value="">-- SELECIONE --</option>
                <option value="Campe√£o do Amanh√£">Campe√£o do Amanh√£</option>
                <option value="Cavaleiro das Trevas">Cavaleiro das Trevas</option>
                <option value="G√™nio">G√™nio</option>
                <option value="Herdeiro do Manto">Herdeiro do Manto</option>
                <option value="Forasteiro">Forasteiro</option>
                <option value="Guerreiro">Guerreiro</option>
            </select>
        </div>
        <div class="input-group"><label>JOGADOR</label><input type="text" id="player"></div>
    </div>

    <h2>O C√çRCULO DOURADO</h2>
    <div class="grid-3">
        <div><label>POR QUE LUTA?</label><div class="editable-box" contenteditable="true" id="motiv_why"></div></div>
        <div><label>COMO LUTA?</label><div class="editable-box" contenteditable="true" id="motiv_how"></div></div>
        <div><label>POR QUEM LUTA?</label><div class="editable-box" contenteditable="true" id="motiv_whom"></div></div>
    </div>

    <h2>ATRIBUTOS (5 PAX p/ +3)</h2>
    <p style="color:#666; font-size:0.8rem; margin-top:-10px; margin-bottom:20px;">* Base aumenta de 3 em 3. Use B√¥nus para valores de Origem/Itens.</p>
    <div class="grid-6">
        <div class="stat-box">
            <label>POT√äNCIA</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="pot_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="pot_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="pot_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
        <div class="stat-box">
            <label>PRECIS√ÉO</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="prec_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="prec_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="prec_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
        <div class="stat-box">
            <label>AGILIDADE</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="agi_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="agi_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="agi_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
        <div class="stat-box">
            <label>RESIST√äNCIA</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="res_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="res_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="res_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
        <div class="stat-box">
            <label>MENTE</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="men_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="men_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="men_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
        <div class="stat-box">
            <label>ESP√çRITO</label>
            <div class="stat-split"><div><span class="stat-label-small">Base</span><input type="number" id="esp_base" class="attr-base" value="0" step="3" min="0" oninput="calcPax()"></div><div><span class="stat-label-small">B√¥nus</span><input type="number" id="esp_bonus" class="attr-bonus" value="0" oninput="calcPax()"></div></div>
            <span id="esp_total" class="stat-total">0</span><span class="limit-text">LIMITE!</span>
        </div>
    </div>

    <h2>PODERES & HABILIDADES</h2>
    <div class="add-bar">
        <select id="powerSelect" style="flex: 3;">
            <option value="">-- SELECIONE UMA HABILIDADE --</option>
            <optgroup label="Arqu√©tipos">
                <option value="Presen√ßa Inspiradora (Campe√£o)|3|P√°g. 17|Action">Presen√ßa Inspiradora</option>
                <option value="Ningu√©m Fica Para Tr√°s (Campe√£o)|0|P√°g. 17|Action">Ningu√©m Fica Para Tr√°s</option>
                <option value="Hero√≠smo Cl√°ssico (Campe√£o)|0|P√°g. 17|Action">Hero√≠smo Cl√°ssico</option>
                <option value="Verdade e Justi√ßa (Campe√£o)|4|P√°g. 17|Action">Verdade e Justi√ßa</option>
                <option value="Eu Sou a Noite (Cavaleiro)|0|P√°g. 17|Action">Eu Sou a Noite</option>
                <option value="Cinto de Utilidades (Cavaleiro)|3|P√°g. 17|Action">Cinto de Utilidades</option>
                <option value="Preparo (Cavaleiro)|0|P√°g. 17|Action">Preparo</option>
                <option value="Xeque-Mate (G√™nio)|0|P√°g. 18|Action">Xeque-Mate</option>
                <option value="√â Trivial! (G√™nio)|0|P√°g. 18|Action">√â Trivial!</option>
                <option value="Blabl√°logia (G√™nio)|0|P√°g. 18|Action">Blabl√°logia</option>
                <option value="Estilo Novo! (Herdeiro)|0|P√°g. 18|Action">Estilo Novo!</option>
                <option value="Honrar o Manto (Herdeiro)|0|P√°g. 18|Action">Honrar o Manto</option>
                <option value="Passos Ancestrais (Herdeiro)|0|P√°g. 18|Action">Passos Ancestrais</option>
                <option value="Peso do S√≠mbolo (Herdeiro)|3|P√°g. 18|Action">Peso do S√≠mbolo</option>
            </optgroup>
            <optgroup label="Super Poderes">
                <option value="Campo de For√ßa|3|P√°g. 20">Campo de For√ßa (3 PAX/Grau)</option>
                <option value="Garras/Presas|3|P√°g. 20">Garras/Presas (3 PAX/Grau)</option>
                <option value="Disparo Energ√©tico|4|P√°g. 21">Disparo Energ√©tico (4 PAX/Grau)</option>
                <option value="For√ßa de Acelera√ß√£o|6|P√°g. 21">For√ßa de Acelera√ß√£o (6 PAX/Grau)</option>
                <option value="Manipula√ß√£o Elemental|3|P√°g. 22">Manipula√ß√£o Elemental (3 PAX/Grau)</option>
                <option value="Sentidos Especiais|3|P√°g. 22">Sentidos Especiais (3 PAX/Grau)</option>
                <option value="Super-For√ßa|3|P√°g. 23">Super-For√ßa (3 PAX/Grau)</option>
                <option value="Resist√™ncia Aprimorada|3|P√°g. 23">Resist√™ncia Aprimorada (3 PAX/Grau)</option>
                <option value="Velocidade Sobre-Humana|3|P√°g. 23">Velocidade Sobre-Humana (3 PAX/Grau)</option>
                <option value="Voo|3|P√°g. 24">Voo (3 PAX/Grau)</option>
            </optgroup>
            <optgroup label="Treinamento Marcial">
                <option value="Mestre Marcial|6|P√°g. 25">Mestre Marcial (6 PAX/Grau)</option>
                <option value="Espadachim|6|P√°g. 26">Espadachim (6 PAX/Grau)</option>
                <option value="Atirador|6|P√°g. 26">Atirador (6 PAX/Grau)</option>
            </optgroup>
            <optgroup label="Tecnologia">
                <option value="Exoesqueleto|8|P√°g. 27">Exoesqueleto (8 PAX/Grau)</option>
                <option value="Esferas Tecnol√≥gicas|4|P√°g. 28">Esferas Tecnol√≥gicas (4 PAX/Grau)</option>
            </optgroup>
            <optgroup label="Conhecimentos (4 PAX)">
                <option value="Acad√™mico|4|P√°g. 29|fix">Acad√™mico</option>
                <option value="Acrobacia|4|P√°g. 30|fix">Acrobacia</option>
                <option value="Medicina|4|P√°g. 30|fix">Medicina</option>
                <option value="Subterf√∫gio|4|P√°g. 30|fix">Subterf√∫gio</option>
                <option value="Tech|4|P√°g. 30|fix">Tech</option>
            </optgroup>
            <optgroup label="Tra√ßos (4 PAX)">
                <option value="Beleza Rara|4|P√°g. 31|fix">Beleza Rara</option>
                <option value="Poliglota|4|P√°g. 31|fix">Poliglota</option>
                <option value="Contato Confi√°vel|4|P√°g. 31|fix">Contato Confi√°vel</option>
                <option value="Casca Grossa|4|P√°g. 31|fix">Casca Grossa</option>
                <option value="Frase de Efeito|4|P√°g. 31|fix">Frase de Efeito</option>
                <option value="Gadgets de Bolso|4|P√°g. 31|fix">Gadgets de Bolso</option>
                <option value="Voz da Multid√£o|4|P√°g. 32|fix">Voz da Multid√£o</option>
                <option value="Influencer|4|P√°g. 32|fix">Influencer</option>
                <option value="Identidade Secreta|4|P√°g. 32|fix">Identidade Secreta</option>
                <option value="Dupla Din√¢mica|4|P√°g. 32|fix">Dupla Din√¢mica</option>
                <option value="Filia√ß√£o|4|P√°g. 32|fix">Filia√ß√£o</option>
            </optgroup>
            <option value="Customizado|0|Custom">-- OUTRO / CUSTOMIZADO --</option>
        </select>
        <button class="btn-add" onclick="addFromSelect()">+ ADICIONAR</button>
    </div>
    <div id="powers-container"></div>

    <h2>EQUIPAMENTOS & ITENS</h2>
    <div class="add-bar">
        <select id="equipSelect" style="flex: 3;">
            <option value="">-- SELECIONE EQUIPAMENTO --</option>
            <optgroup label="Armas Marciais (1 PAX)">
                <option value="Espada|1|P√°g. 33|fix">Espada (+1 Atq/Dano)</option>
                <option value="Bast√£o|1|P√°g. 33|fix">Bast√£o (+1 Atq/Dano)</option>
                <option value="Faca|1|P√°g. 33|fix">Faca (+1 Atq/Dano)</option>
                <option value="Tridente|1|P√°g. 33|fix">Tridente (+1 Atq/Dano)</option>
                <option value="Clava|1|P√°g. 33|fix">Clava (+1 Atq/Dano)</option>
            </optgroup>
            <optgroup label="Armas √† Dist√¢ncia (1 PAX)">
                <option value="Arco e Flecha|1|P√°g. 34|fix">Arco e Flecha</option>
                <option value="Pistola|1|P√°g. 34|fix">Pistola</option>
                <option value="Rifle de Precis√£o|1|P√°g. 34|fix">Rifle de Precis√£o</option>
                <option value="Metralhadora|1|P√°g. 34|fix">Metralhadora</option>
            </optgroup>
            <optgroup label="Armaduras">
                <option value="Armadura de Promethium|3|P√°g. 34|fix">Promethium (+2 Def/RD) - 3 PAX</option>
                <option value="Armadura de Amazonium|4|P√°g. 34|fix">Amazonium (+1 Def/Agi/RD) - 4 PAX</option>
                <option value="Armadura de Metal En√©simo|6|P√°g. 34|fix">Metal En√©simo (+1 Def/RD, Voo) - 6 PAX</option>
                <option value="Traje de Kevlar|2|P√°g. 34|fix">Kevlar (+1 Def/RD) - 2 PAX</option>
                <option value="Armadura de Apokolips|5|P√°g. 34|fix">Apokolips (+3 Def/RD, -2 Agi) - 5 PAX</option>
            </optgroup>
            <optgroup label="Apetrechos (1 PAX)">
                <option value="Bomba de Fuma√ßa|1|P√°g. 35|fix">Bomba de Fuma√ßa</option>
                <option value="Arma de Gancho|1|P√°g. 35|fix">Arma de Gancho</option>
                <option value="Spray Curativo|1|P√°g. 35|fix">Spray Curativo</option>
                <option value="Rastreador|1|P√°g. 35|fix">Rastreador</option>
                <option value="Respirador|1|P√°g. 35|fix">Respirador</option>
                <option value="M√°scara Alteradora|1|P√°g. 35|fix">M√°scara Alteradora</option>
                <option value="P.E.M.|1|P√°g. 35|fix">P.E.M.</option>
            </optgroup>
        </select>
        <button class="btn-add" onclick="addEquipFromSelect()">+ ADICIONAR</button>
    </div>
    <div id="equip-container"></div>

    <h2>STATUS DE COMBATE</h2>
    <div class="grid-2">
        <div class="combat-panel">
            <div class="grid-2">
                <div class="input-group"><label>DETERMINA√á√ÉO (Base+Esp)</label><input type="number" id="det" readonly style="color:var(--dc-red); font-weight:bold;"></div>
                <div class="input-group"><label>DEFESA (Base+Res)</label><input type="number" id="def" readonly></div>
                <div class="input-group"><label>REDU√á√ÉO DANO (RD)</label><input type="number" id="rd"></div>
                <div class="input-group"><label>INICIATIVA (Agi)</label><input type="number" id="init" readonly></div>
            </div>
        </div>
        <div>
            <label>CONDI√á√ïES</label>
            <div style="display:grid; gap:5px;">
                <button class="condition-btn" onclick="toggleCond(this)">CANSADO</button>
                <button class="condition-btn" onclick="toggleCond(this)">ARRANHADO (-1)</button>
                <button class="condition-btn" onclick="toggleCond(this)">FERIDO (-2)</button>
                <button class="condition-btn" onclick="toggleCond(this)">GRAVE (-4)</button>
                <button class="condition-btn" onclick="toggleCond(this)">üíÄ DERROTADO</button>
            </div>
        </div>
    </div>

    <h2>A√á√ïES DE COMBATE (REFER√äNCIA)</h2>
    <div class="editable-box" style="font-size: 0.9rem; color: #aaa;">
        <b>‚Ä¢ ATAQUE (1 A√ß√£o):</b> Teste de Precis√£o vs Defesa. Dano na Determina√ß√£o.<br>
        <b>‚Ä¢ BLOQUEIO (1 A√ß√£o):</b> +1 Defesa por Tier at√© pr√≥ximo turno.<br>
        <b>‚Ä¢ ESQUIVA (1 A√ß√£o):</b> Teste de Agilidade vs Ataque para anular dano.<br>
        <b>‚Ä¢ AJUDAR/MOVER (1 A√ß√£o):</b> Auxilia aliado ou o move 1 Dist√¢ncia.<br>
        <b>‚Ä¢ DEFENDER (1 A√ß√£o):</b> +3 Defesa para aliado, -3 para voc√™.<br>
        <b>‚Ä¢ SUPERAR LIMITES (2 A√ß√µes):</b> Marca Condi√ß√£o para recuperar Determina√ß√£o Base.
    </div>

    <h2>ANOTA√á√ïES</h2>
    <div class="editable-box" contenteditable="true" id="notes" style="min-height: 200px;"></div>

</div>

<div class="action-bar">
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadSheet(this)">
    <button class="fab-btn btn-save" onclick="saveSheet()" data-tooltip="Salvar">üíæ</button>
    <button class="fab-btn btn-load" onclick="document.getElementById('fileInput').click()" data-tooltip="Carregar">üìÇ</button>
    <button class="fab-btn btn-print" onclick="window.print()" data-tooltip="Gerar PDF">üñ®Ô∏è</button>
</div>

<script>
    const TIERS = {
        'D': { pax: 40, det: 12, def: 8, attrLimit: 6, powerLimit: 2 },
        'C': { pax: 60, det: 15, def: 10, attrLimit: 9, powerLimit: 2 },
        'B': { pax: 80, det: 18, def: 12, attrLimit: 12, powerLimit: 3 },
        'A': { pax: 100, det: 21, def: 14, attrLimit: 15, powerLimit: 4 },
        'S': { pax: 120, det: 25, def: 16, attrLimit: 18, powerLimit: 5 }
    };
    let currentTier = 'D';

    function setTier(btn, tier) {
        document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTier = tier;
        document.getElementById('rankDisplay').innerText = tier;
        document.getElementById('paxMaxDisplay').innerText = TIERS[tier].pax;
        document.getElementById('tierValue').value = tier;
        calcPax();
    }

    function toggleCond(btn) { btn.classList.toggle('active'); }

    // L√ìGICA SILENCIOSA DA ORIGEM
    function applyOriginLogic() {
        const origin = document.getElementById('origin').value;
        const potBonusInput = document.getElementById('pot_bonus');
        
        // Se for Kryptoniano, aplica +3 automaticamente
        if (origin === 'Kryptoniano') {
            potBonusInput.value = 3;
        } else {
            // Se sair de Kryptoniano e o valor ainda for 3 (e n√£o tiver sido alterado manualmente para outro valor), reseta
            if (potBonusInput.value == 3) potBonusInput.value = 0;
        }
        calcPax();
    }

    // ADICIONAR PODER/ITEM
    function addFromSelect() {
        const select = document.getElementById('powerSelect');
        processAdd(select, 'powers-container');
    }
    
    function addEquipFromSelect() {
        const select = document.getElementById('equipSelect');
        processAdd(select, 'equip-container', true);
    }

    function processAdd(select, containerId, isEquip = false) {
        const val = select.value;
        if(!val) return;
        const parts = val.split('|');
        createPowerCard(parts[0], parseInt(parts[1]), parts[2], parts[3] || 'grad', containerId, '', null, isEquip);
        select.value = "";
    }

    function createPowerCard(name, cost, page, type, containerId, savedDesc = '', savedCost = null, isEquip = false) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = isEquip ? 'power-card equip' : 'power-card';
        
        let costInput = '';
        if (type === 'fix') {
            costInput = `<input type="number" class="p-cost" value="${cost}" readonly style="width:50px;"> PAX`;
        } else if (type === 'Custom') {
            costInput = `<input type="number" class="p-cost" value="${savedCost || 0}" oninput="calcPax()" style="width:60px;"> PAX`;
        } else if (type === 'Action') {
            costInput = `<input type="text" class="p-cost" value="0" readonly style="width:30px; border:none; background:transparent; color:#aaa;">`;
        } else {
            const initialVal = savedCost || cost;
            const initialGrade = initialVal/cost;
            costInput = `Grau: <input type="number" class="p-grade" value="${initialGrade || 1}" min="1" max="5" style="width:50px;" onchange="updatePowerCost(this, ${cost})"> = <span class="p-total">${initialVal}</span> PAX`;
        }

        div.innerHTML = `
            <button class="btn-remove" onclick="removePower(this)">‚úï</button>
            <div class="power-header">
                <div class="power-name">${name}</div>
                <div class="power-meta">${page}</div>
                <div class="cost-ctrl">
                    ${costInput}
                    <label style="display:inline; font-size:0.7rem; color:#aaa; margin:0;">
                        <input type="checkbox" class="free-check" onchange="calcPax()"> Gratuito/Origem
                    </label>
                </div>
            </div>
            <div class="editable-box p-desc" contenteditable="true" placeholder="Descri√ß√£o...">${savedDesc}</div>
            <div class="limit-text">‚ö†Ô∏è ERRO: LIMITE DE GRAU (${TIERS[currentTier].powerLimit}) EXCEDIDO!</div>
            <div class="limit-text-warn">‚ö†Ô∏è AVISO: Apenas 1 poder permitido neste Grau.</div>
        `;
        container.appendChild(div);
        calcPax();
    }

    function updatePowerCost(input, base) {
        const grade = parseInt(input.value) || 1;
        const total = grade * base;
        input.parentElement.querySelector('.p-total').innerText = total;
        calcPax();
    }

    function removePower(btn) { btn.parentElement.remove(); calcPax(); }

    function calcPax() {
        let totalSpent = 0;
        const tierData = TIERS[currentTier];

        // 1. ATRIBUTOS
        document.querySelectorAll('.stat-box').forEach(box => {
            const baseInput = box.querySelector('.attr-base');
            const bonusInput = box.querySelector('.attr-bonus');
            let base = parseInt(baseInput.value) || 0;
            if(base % 3 !== 0) { base = Math.floor(base/3)*3; baseInput.value = base; } // Auto-corrige
            const total = base + (parseInt(bonusInput.value) || 0);
            box.querySelector('.stat-total').innerText = total > 0 ? '+' + total : total;
            if (total > tierData.attrLimit) box.classList.add('limit-error');
            else box.classList.remove('limit-error');
            if(base > 0) totalSpent += (base / 3) * 5;
        });

        // 2. PODERES & VALIDA√á√ÉO
        let maxGradeCount = 0;
        document.querySelectorAll('.power-card').forEach(card => {
            const gradeInput = card.querySelector('.p-grade');
            if(gradeInput) {
                const grade = parseInt(gradeInput.value) || 1;
                if (grade === tierData.powerLimit) maxGradeCount++;
            }
        });

        document.querySelectorAll('.power-card').forEach(card => {
            const gradeInput = card.querySelector('.p-grade');
            card.classList.remove('limit-error'); card.classList.remove('limit-warning');

            if(gradeInput) {
                const grade = parseInt(gradeInput.value) || 1;
                if(grade > tierData.powerLimit) card.classList.add('limit-error');
                else if(grade === tierData.powerLimit && maxGradeCount > 1) card.classList.add('limit-warning');
            }

            if(!card.querySelector('.free-check').checked) {
                if (card.innerHTML.includes('(Hab. Arqu√©tipo)')) return;
                if (card.querySelector('.p-total')) totalSpent += parseInt(card.querySelector('.p-total').innerText) || 0;
                else if (card.querySelector('.p-cost')) totalSpent += parseInt(card.querySelector('.p-cost').value) || 0;
            }
        });

        document.getElementById('paxSpentDisplay').innerText = Math.ceil(totalSpent);
        const status = document.getElementById('paxStatus');
        if(totalSpent > tierData.pax) { status.innerText = "‚ö†Ô∏è EXCEDIDO!"; status.className = "pax-status over"; }
        else { status.innerText = "OK"; status.className = "pax-status ok"; }

        // Derivados
        const esp = parseInt(document.getElementById('esp_base').value||0) + parseInt(document.getElementById('esp_bonus').value||0);
        const res = parseInt(document.getElementById('res_base').value||0) + parseInt(document.getElementById('res_bonus').value||0);
        const agi = parseInt(document.getElementById('agi_base').value||0) + parseInt(document.getElementById('agi_bonus').value||0);
        
        document.getElementById('det').value = tierData.det + esp;
        document.getElementById('def').value = tierData.def + res;
        document.getElementById('init').value = agi;
    }

    function saveSheet() {
        const data = { inputs: {}, content: {}, powers: [], equips: [], conditions: [], tier: '' };
        document.querySelectorAll('input:not(.p-grade):not(.p-cost):not(.attr-base):not(.attr-bonus):not(.free-check)').forEach(el => { if(el.id) data.inputs[el.id] = el.value; });
        const attrs = {};
        document.querySelectorAll('.attr-base').forEach(el => attrs[el.id] = el.value);
        document.querySelectorAll('.attr-bonus').forEach(el => attrs[el.id] = el.value);
        data.attrs = attrs;
        document.querySelectorAll('.editable-box:not(.p-desc)').forEach(el => { if(el.id) data.content[el.id] = el.innerHTML; });
        data.tier = document.getElementById('tierValue').value;
        document.querySelectorAll('.condition-btn').forEach((el, i) => { if(el.classList.contains('active')) data.conditions.push(i); });
        
        document.querySelectorAll('#powers-container .power-card').forEach(card => extractCardData(card, data.powers));
        document.querySelectorAll('#equip-container .power-card').forEach(card => extractCardData(card, data.equips));

        const name = document.getElementById('heroName').value || 'heroi';
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${name}_JLU.json`;
        link.click();
    }

    function extractCardData(card, array) {
        let costVal = 0;
        let type = 'grad';
        if(card.innerHTML.includes('Hab. Arqu√©tipo')) type = 'Action';
        else if(card.querySelector('.p-total')) { costVal = card.querySelector('.p-total').innerText; type = 'grad'; }
        else { costVal = card.querySelector('.p-cost').value; type = card.querySelector('.p-cost').readOnly ? 'fix' : 'Custom'; }

        array.push({
            name: card.querySelector('.power-name').innerText,
            page: card.querySelector('.power-meta').innerText,
            cost: costVal,
            desc: card.querySelector('.p-desc').innerHTML,
            free: card.querySelector('.free-check').checked,
            type: type
        });
    }

    function loadSheet(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                for (const key in data.inputs) { const el = document.getElementById(key); if(el) el.value = data.inputs[key]; }
                for (const key in data.content) { const el = document.getElementById(key); if(el) el.innerHTML = data.content[key]; }
                if(data.attrs) { for (const key in data.attrs) { const el = document.getElementById(key); if(el) el.value = data.attrs[key]; } }
                if(data.tier) setTier(document.querySelectorAll('.tier-btn')[['D','C','B','A','S'].indexOf(data.tier)], data.tier);
                
                document.querySelectorAll('.condition-btn').forEach(el => el.classList.remove('active'));
                if(data.conditions) data.conditions.forEach(i => document.querySelectorAll('.condition-btn')[i].classList.add('active'));
                
                document.getElementById('powers-container').innerHTML = '';
                if(data.powers) data.powers.forEach(p => createPowerCard(p.name, parseInt(p.cost), p.page, p.type, 'powers-container', p.desc, p.cost, false));
                
                document.getElementById('equip-container').innerHTML = '';
                if(data.equips) data.equips.forEach(p => createPowerCard(p.name, parseInt(p.cost), p.page, p.type, 'equip-container', p.desc, p.cost, true));

                calcPax();
            } catch (err) { alert('Erro ao ler arquivo.'); }
        };
        reader.readAsText(file);
        input.value = '';
    }
    
    window.onload = () => calcPax();
</script>

</body>
</html>